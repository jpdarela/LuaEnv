````instructions
# GitHub Copilot Instructions for Lua MSVC Build Project

## Status: MODERNIZED WITH UUID-BASED REGISTRY SYSTEM [SUCCESS]

The Windows/MSVC Lua/LuaRocks build system has been completely redesigned and modernized with a UUID-based registry system. The new architecture provides multiple, fully isolated Lua installations with centralized management through %USERPROFILE%\.luaenv. All legacy systems have been replaced with modern, robust alternatives.

### System Architecture Overview

The new LuaEnv system provides:

1. **UUID-Based Installations**: Each installation has a unique identifier for precise tracking
2. **Centralized Registry**: All installations managed through %USERPROFILE%\.luaenv\registry.json
3. **Isolated Environments**: Each installation has its own LuaRocks package tree
4. **Alias Support**: User-friendly aliases for installations (e.g., "dev", "prod", "test")
5. **Status Tracking**: Active, broken, and removed installation states
6. **Default Management**: Automatic default installation selection
7. **Complete Isolation**: No interference between different installations

### Current System State

The system is operational with the following components:

1. **registry.py**: Complete registry management system with UUID tracking
2. **setup_lua.py**: Modernized installation creator with registry integration
3. **use-lua.ps1**: Registry-aware environment configuration script
4. **Centralized Storage**: All installations in %USERPROFILE%\.luaenv\installations\
5. **Environment Trees**: Isolated LuaRocks trees in %USERPROFILE%\.luaenv\environments\

### Verified Functionality

[OK] Registry Management: Create, list, remove, and manage installations
[OK] UUID Resolution: Full and partial UUID matching for installation selection
[OK] Alias System: User-friendly aliases with duplicate detection
[OK] Environment Isolation: Completely isolated LuaRocks package trees
[OK] Status Tracking: Active, broken, and removed installation states
[OK] Default Selection: Automatic default installation management
[OK] Package Installation: LuaRocks packages install to correct isolated trees
[OK] Environment Configuration: PowerShell script correctly sets up session variables
[OK] Visual Studio Integration: Proper MSVC environment setup with directory preservation

## DO NOT EDIT START FROM HERE

ATTENTION: WHEN ASKED FOR IDEAS IN THE AGENT MODE, DO NOT EDIT ANY CODE. PROVIDE IDEAS ONLY.
ATTENTION: AVOID THE CREATION OF BACKUP FILES .backup and NEW files .new. If you need to use these copies. MAKE SURE TO DELETE THEM AS SOON AS POSSIBLE.
ATTENTION: DO NOT WORK IN SILENCE. PRINT MESSAGES TO THE CONSOLE FOR EACH STEP.
## Coding Standards and Preferences

### Character Encoding Rules
- **NO UNICODE SYMBOLS** in code output, messages, or comments
- Use ASCII-only characters for all text output
- Replace common Unicode symbols with ASCII alternatives:
  - âœ… â†’ `[OK]` or `[SUCCESS]`
  - âŒ â†’ `[ERROR]` or `[FAILED]`
  - âš ï¸ â†’ `[WARNING]`
  - ðŸ“ â†’ `[DIR]` or `[FOLDER]`
  - ðŸ“„ â†’ `[FILE]`
  - ðŸ”§ â†’ `[CONFIG]`
  - ðŸš€ â†’ `[LAUNCH]`
  - ðŸ’¾ â†’ `[SAVE]`
  - ðŸ” â†’ `[SEARCH]`

### Rationale
- Ensures universal compatibility across all terminals and systems
- Prevents encoding issues with different locales or terminal settings
- Maintains professional appearance without dependency on Unicode support
- Better compatibility with legacy systems and tools
- Cleaner output in logs and CI/CD pipelines

### Output Message Format
Use consistent ASCII prefixes for different message types:
- Success: `[OK] Operation completed successfully`
- Error: `[ERROR] Something went wrong`
- Warning: `[WARNING] Potential issue detected`
- Info: `[INFO] General information`
- Debug: `[DEBUG] Debugging information`

### File Listings
For directory and file listings, use:
- Directories: `[DIR] folder_name/ (X items)`
- Files: `[FILE] filename.ext (file_size)`
- Links: `[LINK] link_name -> target`

### Build System Specific
- This is a Windows-focused Lua/LuaRocks build system
- Use PowerShell-compatible commands when generating shell examples
- Ensure absolute paths for cross-directory operations
- All extracted source code goes in the `backend/extracted/` folder
- Downloads are managed in version-specific folders under `backend/downloads/`

### Python Code Style
- Follow existing patterns in the codebase
- Use Path objects from pathlib for file operations
- Include proper error handling with descriptive ASCII messages
- Maintain compatibility with existing utility functions in `utils.py`


## EDITABLE SECTION STARTS HERE. UPDATE THIS SECTION WITH NEW INFORMATION AS NEEDED
## REVIEW THIS SECTIONS REGULARLY TO KEEP IT UP-TO-DATE


## Project Structure Context

```
backend/
â”œâ”€â”€ extracted/              # All extracted source code (build isolation)
â”‚   â”œâ”€â”€ lua-5.4.7/         # Lua source code
â”‚   â”œâ”€â”€ lua-5.4.7-tests/   # Lua test suite
â”‚   â”œâ”€â”€ lua-5.4.8/         # Different Lua version
â”‚   â”œâ”€â”€ lua-5.4.8-tests/   # Tests for different version
â”‚   â””â”€â”€ luarocks-3.12.2-windows-64/  # LuaRocks (shared)
â”œâ”€â”€ downloads/              # Downloaded archives (organized by version)
â”‚   â”œâ”€â”€ lua/               # Lua source downloads by version
â”‚   â””â”€â”€ luarocks/          # LuaRocks downloads by version-platform
â”œâ”€â”€ utils.py               # Utility functions (download, extract, config)
â”œâ”€â”€ download_manager.py    # Version-aware download management
â”œâ”€â”€ download_lua_luarocks.py  # Main download/extract script
â”œâ”€â”€ config.py              # Configuration management
â”œâ”€â”€ setup_build.py         # Copy build scripts to extracted folders
â”œâ”€â”€ build_config.txt       # Current build configuration
â””â”€â”€ version_cache.json     # Cached version information (auto-generated)
```

## Extracted Folder Management

The system uses a dedicated `extracted/` folder for all extracted source code, providing:

### Key Benefits
- **Clean Organization**: All source code in one dedicated location
- **Version Isolation**: Multiple versions can coexist without conflicts
- **Easy Cleanup**: Simple commands to clean and re-extract
- **Build Isolation**: Build operations don't interfere with downloads
- **Flexibility**: Easy to switch between versions or test configurations

### Folder Structure Features
- Different Lua versions extract to separate folders (`lua-X.X.X`)
- LuaRocks versions are shared when compatible
- Clean extraction on version changes
- All build scripts reference the extracted folder instead of backend root

## Core Scripts and Functions

### registry.py - UUID-Based Installation Registry System
**Purpose**: Centralized management of all Lua installations using UUID-based tracking with support for aliases, status management, and environment isolation.

**Installation Registry Structure**:
```
%USERPROFILE%\.luaenv\
â”œâ”€â”€ registry.json              # Central installation registry
â”œâ”€â”€ registry.json.backup       # Automatic backup of registry
â”œâ”€â”€ installations/              # UUID-named installation directories
â”‚   â””â”€â”€ {uuid}/                # Individual installation (bin/, lib/, include/, doc/, luarocks/)
â”œâ”€â”€ environments/               # UUID-named isolated LuaRocks trees
â”‚   â””â”€â”€ {uuid}/                # Individual environment (lib/, share/)
â””â”€â”€ cache/                     # Temporary files and build cache
```

**Command Line Arguments**:
- `python registry.py status` - Show detailed registry status and all installations
- `python registry.py list` - List all installations with details
- `python registry.py create --lua 5.4.8 --luarocks 3.12.2 --build dll --config release` - Create installation record
- `python registry.py remove <id_or_alias>` - Remove installation by UUID or alias
- `python registry.py set-alias <id> <alias>` - Set alias for installation
- `python registry.py remove-alias <alias>` - Remove alias from installation
- `python registry.py set-default <id_or_alias>` - Set default installation
- `python registry.py validate` - Validate all installations and fix issues
- `python registry.py cleanup` - Remove broken/orphaned installations
- `python registry.py backup` - Create manual registry backup
- `python registry.py restore <backup_file>` - Restore registry from backup
- `python registry.py export <file>` - Export registry to JSON file
- `python registry.py import <file>` - Import installations from JSON file

**Key Methods**:
- `create_installation()` - Create new installation record with UUID
- `get_installation(id_or_alias)` - Retrieve installation by UUID or alias
- `list_installations()` - Get all installations with metadata
- `remove_installation(id_or_alias)` - Remove installation and cleanup
- `resolve_installation(id_or_alias)` - Resolve partial UUID or alias to full record
- `set_alias(installation_id, alias)` - Set user-friendly alias
- `get_default()` - Get default installation record
- `set_default(id_or_alias)` - Set default installation
- `update_status(installation_id, status)` - Update installation status (active/broken/removed)
- `validate_installation(installation_id)` - Check installation integrity
- `get_environment_path(installation_id)` - Get isolated LuaRocks environment path

**Installation Record Structure**:
```json
{
  "id": "8202bd2b-1f86-4cfb-acf4-a14641add5d2",
  "name": "Lua 5.4.8 DLL Release",
  "alias": "test",
  "lua_version": "5.4.8",
  "luarocks_version": "3.12.2",
  "build_type": "dll",
  "build_config": "release",
  "status": "active",
  "created": "2025-06-30T10:15:30Z",
  "last_used": "2025-06-30T12:45:15Z",
  "installation_path": "C:\\Users\\darel\\.luaenv\\installations\\8202bd2b-1f86-4cfb-acf4-a14641add5d2",
  "environment_path": "C:\\Users\\darel\\.luaenv\\environments\\8202bd2b-1f86-4cfb-acf4-a14641add5d2"
}
```

### setup_lua.py - UUID-Based Installation Creator
**Purpose**: Creates new Lua installations integrated with the registry system, supporting multiple build types and complete environment isolation.

**Command Line Arguments**:
- `python setup_lua.py` - Create static release build with current config
- `python setup_lua.py --dll` - Create DLL release build
- `python setup_lua.py --debug` - Create static debug build
- `python setup_lua.py --dll --debug` - Create DLL debug build
- `python setup_lua.py --name "Development Build" --alias dev` - Create with custom name and alias
- `python setup_lua.py --list` - List all installations
- `python setup_lua.py --remove <id_or_alias>` - Remove installation by UUID or alias
- `python setup_lua.py --skip-env-check` - Skip Visual Studio environment validation
- `python setup_lua.py --skip-tests` - Skip test suite after building
- `python setup_lua.py --help` - Show detailed help with examples

**Build Process Integration**:
1. **Registry Creation**: Creates installation record with UUID before building
2. **Environment Setup**: Calls `setenv()` with directory preservation
3. **Environment Validation**: Uses check-env.bat for VS environment verification
4. **Download Phase**: Downloads and extracts sources to backend/extracted/
5. **Build Phase**: Compiles Lua and installs to UUID-named directory
6. **LuaRocks Setup**: Configures LuaRocks with isolated environment tree
7. **Testing**: Runs comprehensive test suite including official Lua tests
8. **Registry Update**: Marks installation as active or broken based on results

**Installation Isolation Features**:
- **Unique Paths**: Each installation in separate UUID-named directory
- **Isolated Trees**: LuaRocks packages install to per-installation environment
- **No Conflicts**: Multiple versions and build types can coexist
- **Status Tracking**: Broken builds marked and can be debugged or removed
- **Alias Support**: User-friendly names for easy identification

### use-lua.ps1 - Registry-Aware Environment Setup
**Purpose**: Configures PowerShell session to use specific Lua installation from registry with complete Visual Studio integration.

**Command Line Arguments**:
- `.\use-lua.ps1` - Use default installation from registry
- `.\use-lua.ps1 -Id <uuid>` - Use installation by UUID (full or partial, min 8 chars)
- `.\use-lua.ps1 -Alias <name>` - Use installation by alias
- `.\use-lua.ps1 -List` - List all available installations
- `.\use-lua.ps1 -Info` - Show current environment information
- `.\use-lua.ps1 -Tree <path>` - Use custom LuaRocks package tree path
- `.\use-lua.ps1 -Help` - Display comprehensive help

**Registry Integration Features**:
- **Installation Resolution**: Resolves UUIDs, aliases, or uses default
- **Registry Loading**: Reads %USERPROFILE%\.luaenv\registry.json
- **Status Validation**: Checks installation status before activation
- **Environment Isolation**: Sets up per-installation LuaRocks trees
- **Usage Tracking**: Updates last_used timestamp in registry

**Environment Configuration**:
- **Visual Studio Setup**: Automatically configures VS Developer Shell
- **PATH Configuration**: Adds Lua and LuaRocks executables to session PATH
- **Module Paths**: Sets LUA_PATH and LUA_CPATH for isolated environments
- **LuaRocks Config**: Creates temporary config for session isolation
- **Tree Management**: Ensures LuaRocks uses installation-specific package tree

**Session Isolation**:
- **Environment Variables**: All changes are session-only
- **Config Files**: Temporary LuaRocks config in %TEMP%
- **No System Impact**: No permanent system changes
- **Clean Sessions**: Each activation starts with clean environment

### Legacy System Migration

**Replaced Components**:
- **Old setup_lua.py**: Single-installation system with .lua_prefix.txt files
- **Old use-lua.ps1**: File-based installation detection
- **Manual Management**: No centralized tracking or multiple installation support

**Migration Path**:
- Legacy installations continue to work but are not registry-managed
- New installations automatically use UUID-based registry system
- No backward compatibility layer needed as systems are independent
- Users can migrate by creating new installations and removing old ones

**Advantages of New System**:
- **Multiple Installations**: Support for unlimited concurrent installations
- **No Conflicts**: Complete isolation between installations
- **Easy Management**: Centralized registry with powerful CLI tools
- **Robust Tracking**: Status management, aliases, defaults, usage tracking
- **Environment Safety**: No cross-contamination between installations

### config.py - Configuration Management System
**Purpose**: Manages version configuration, validates URLs, discovers available versions, and handles caching.

**Command Line Arguments**:
- `python config.py` - Show current configuration
- `python config.py --check` - Validate current download URLs
- `python config.py --discover` - Discover available versions (use cache)
- `python config.py --discover --refresh` - Discover versions (refresh cache)
- `python config.py --cache-info` - Show cache information
- `python config.py --clear-cache` - Clear version cache
- `python config.py --help` - Show help

**Key Functions**:
- `load_config()` - Load configuration from build_config.txt file
- `get_lua_url()` - Get download URL for Lua source
- `get_lua_tests_url()` - Get download URL for Lua test suite
- `get_luarocks_url()` - Get download URL for LuaRocks
- `get_lua_dir_name()` - Get expected directory name after extracting Lua (e.g., "lua-5.4.8")
- `get_luarocks_dir_name()` - Get expected directory name after extracting LuaRocks (e.g., "luarocks-3.12.2-windows-64")
- `get_lua_tests_dir_name()` - Get expected directory name after extracting Lua tests (e.g., "lua-5.4.8-tests")
- `get_download_filenames()` - Get dict of expected download filenames
- `check_version_compatibility()` - Check if Lua and LuaRocks versions are compatible
- `validate_current_configuration()` - Validate all download URLs are accessible
- `get_available_lua_versions(max_versions=10, use_cache=True, force_refresh=False)` - Discover available Lua versions from lua.org
- `get_available_luarocks_versions(platform="windows-64", max_versions=8, use_cache=True, force_refresh=False)` - Discover available LuaRocks versions
- `load_version_cache(show_message=True)` - Load cached version information (240 hour expiry)
- `save_version_cache(lua_versions, luarocks_versions)` - Save version information to cache
- `clear_version_cache()` - Clear the version cache file
- `check_url_exists(url, timeout=10)` - Check if a URL is accessible

**Operational Notes**:
- **Cache Management**: Cache expires after 240 hours, stored in `version_cache.json`
- **Rate Limiting**: Implements respectful delays between server requests
- **Error Handling**: Returns HTTP 404 for invalid versions, provides clear error messages
- **Version Discovery**: Currently finds 9 Lua versions (5.4.0-5.4.8) and 8 LuaRocks versions
- **Platform Support**: Supports both windows-64 and windows-32 platforms
- **Performance**: Cache reduces server load and improves response times significantly
- **Validation**: All URLs are validated before download attempts
- **Integration**: Works seamlessly with download_lua_luarocks.py and setup_build.py

### download_lua_luarocks.py - Main Download and Extraction Script
**Purpose**: Downloads and extracts Lua source code and LuaRocks using version-aware management.

**Command Line Arguments**:
- `python download_lua_luarocks.py` - Download and extract files
- `python download_lua_luarocks.py --config` - Show current configuration
- `python download_lua_luarocks.py --list` - List downloaded versions
- `python download_lua_luarocks.py --cleanup` - Clean up old downloads (keep 3)
- `python download_lua_luarocks.py --cleanup --all` - Clean up all but latest
- `python download_lua_luarocks.py --info` - Show registry information
- `python download_lua_luarocks.py --list-extracted` - List extracted contents
- `python download_lua_luarocks.py --clean-extracted` - Clean extracted folder
- `python download_lua_luarocks.py --clean-extracted --force` - Clean without confirmation
- `python download_lua_luarocks.py --re-extract` - Re-extract current version
- `python download_lua_luarocks.py --help` - Show help

**Key Functions**:
- `download()` - Main download function using DownloadManager
- `extract()` - Extract downloaded files to extracted folder
- `main()` - Command line interface handler

### setup_build.py - Build Script Setup
**Purpose**: Copies build scripts to appropriate directories in the extracted folder structure.

**Command Line Arguments**:
- `python setup_build.py` - Setup for static release build
- `python setup_build.py --dll` - Setup for DLL release build
- `python setup_build.py --debug` - Setup for static debug build
- `python setup_build.py --dll --debug` - Setup for DLL debug build
- `python setup_build.py --help` - Show help

**Key Functions**:
- `copy_build_scripts()` - Copy build scripts to extracted/lua-X.X.X/src and extracted/luarocks-X.X.X-platform directories

**Build Types**:
- Static Release: Optimized static library build (default)
- DLL Release: Optimized DLL build
- Static Debug: Unoptimized static build with debug symbols
- DLL Debug: Unoptimized DLL build with debug symbols

### build.py - Main Build Script
**Purpose**: Compiles Lua and sets up LuaRocks using the extracted folder structure and MSVC tools.

**Command Line Arguments**:
- `python build.py` - Static release build to ./lua
- `python build.py --dll` - DLL release build to ./lua
- `python build.py --debug` - Static debug build to ./lua
- `python build.py --dll --debug` - DLL debug build to ./lua
- `python build.py --prefix <path>` - Build to custom installation directory
- `python build.py --help` - Show help

**Key Functions**:
- `run_build_scripts(build_dll=False, build_debug=False, install_dir=INSTALL_DIR)` - Main build function

**Build Process**:
1. Validates extracted folder structure exists
2. Changes to extracted/lua-X.X.X/src directory
3. Runs appropriate build script (build-static.bat, build-dll.bat, etc.)
4. Copies LuaRocks to installation directory
5. Configures LuaRocks for the Lua installation

**Prerequisites**:
- Visual Studio environment must be set up (use setenv.ps1)
- Sources downloaded (download_lua_luarocks.py)
- Build scripts copied (setup_build.py)

### Environment Setup Scripts

#### setenv.ps1 - Visual Studio Environment Setup
**Purpose**: Sets up Visual Studio build environment with proper paths and variables.

**Command Line Arguments**:
- `.\setenv.ps1` - Set up default x64 environment
- `.\setenv.ps1 -Arch x86` - Set up x86 environment
- `.\setenv.ps1 -Arch x64` - Set up x64 environment (explicit)
- `.\setenv.ps1 -Help` - Show help

**Key Features**:
- Auto-detects Visual Studio installations (2022, 2019, 2017)
- Supports Community, Professional, Enterprise editions
- Sets up compiler, linker, and SDK paths
- Configures environment variables for MSVC tools

#### check-env.bat - Environment Validation
**Purpose**: Validates that Visual Studio build environment is properly configured.

**Command Line Arguments**:
- `check-env.bat` - Interactive environment check
- `check-env.bat --quiet` - Programmatic check (returns exit codes)

**Validation Checks**:
- **Environment Variables**: VCINSTALLDIR, VSCMD_ARG_TGT_ARCH, WindowsSdkDir, WindowsSDKVersion
- **Build Tools**: cl.exe (compiler), link.exe (linker), lib.exe (librarian), nmake.exe
- **Library Paths**: LIB environment variable, MSVCRT.lib, ucrt.lib, kernel32.lib
- **Exit Codes**: 0 = success, 1 = issues found

**Quiet Mode Output**:
- `ENV_CHECK_RESULT=SUCCESS` or `ENV_CHECK_RESULT=FAILED`
- `ENV_CHECK_ISSUES=<semicolon_separated_issues>` (on failure)

## Essential Utility Functions (utils.py)

### File Operations
- `download_file(url, dest)` - Download file from URL to destination
- `extract_file(file_path, extract_to=None, move_callback=None)` - Extract .tar.gz or .zip files
- `get_file_size(file_path)` - Get file size in bytes
- `format_file_size(size_bytes)` - Format file size with units (KB, MB, GB)
- `verify_file_exists(file_path)` - Verify file exists and return Path object

### Configuration Management
- `update_build_config(lua_version, luarocks_version, luarocks_platform, config_file="build_config.txt")` - Update build configuration file
- `read_build_config(config_file="build_config.txt")` - Read and parse build configuration file

### Extracted Folder Management
- `ensure_extracted_folder(base_path=".")` - Create extracted folder if it doesn't exist, returns Path
- `clean_extracted_folder(base_path=".", confirm=True)` - Remove all contents from extracted folder
- `list_extracted_contents(base_path=".")` - List and display contents of extracted folder
- `get_extracted_path(item_name, base_path=".")` - Get path to specific item in extracted folder

### Build Script Integration
**Usage Pattern**:
```python
from utils import get_extracted_path, ensure_extracted_folder

# Get path to specific extracted item
lua_path = get_extracted_path("lua-5.4.8")
if lua_path:
    print(f"Lua source at: {lua_path}")

# Or use the extracted folder directly
extracted_folder = ensure_extracted_folder()
lua_source = extracted_folder / "lua-5.4.8"
```

**Migration Notes**: Build scripts should reference the `extracted/` folder instead of backend root. Use utility functions for path management.

## Configuration Files

### build_config.txt
**Purpose**: Main configuration file for version settings.
**Format**:
```
LUA_VERSION=5.4.8
LUAROCKS_VERSION=3.12.2
LUAROCKS_PLATFORM=windows-64
```

### version_cache.json (Auto-generated)
**Purpose**: Caches discovered version information to reduce server requests.
**Expiry**: 240 hours
**Contains**: Available Lua and LuaRocks versions with timestamps

## UUID-Based Registry System Workflows

### Basic Installation Creation Workflow
```powershell
# 1. Create a new installation (automatically handles everything)
python setup_lua.py --dll --name "Development Build" --alias dev

# 2. Activate the installation in current session
.\use-lua.ps1 -Alias dev

# 3. Verify installation
lua -v
luarocks --version

# 4. Install packages (isolated to this installation)
luarocks install penlight
lua -e "require('pl.pretty').dump({hello='world'})"
```

### Multi-Installation Management Workflow
```powershell
# Create multiple installations for different purposes
python setup_lua.py --name "Production" --alias prod
python setup_lua.py --dll --debug --name "Debug Build" --alias debug
python setup_lua.py --name "Testing" --alias test

# List all installations
python setup_lua.py --list
# or
.\use-lua.ps1 -List
# or
python registry.py status

# Switch between installations
.\use-lua.ps1 -Alias prod    # Use production build
.\use-lua.ps1 -Alias debug   # Switch to debug build
.\use-lua.ps1               # Use default installation

# Set default installation
python registry.py set-default test

# Clean up unused installations
python setup_lua.py --remove debug
python registry.py remove old-installation-id
```

### Advanced Registry Management Workflow
```powershell
# Registry maintenance
python registry.py validate                    # Check all installations
python registry.py cleanup                     # Remove broken installations
python registry.py backup                      # Create manual backup

# Alias management
python registry.py set-alias 8202bd2b stable   # Set alias for UUID
python registry.py remove-alias old-alias      # Remove alias

# Export/Import installations
python registry.py export my-setups.json       # Export current registry
python registry.py import shared-setups.json   # Import from another system
```

### Development Environment Setup Workflow
```powershell
# Set up isolated development environment
python setup_lua.py --dll --name "Project Alpha" --alias alpha
.\use-lua.ps1 -Alias alpha

# Install project-specific packages
luarocks install luafilesystem
luarocks install penlight
luarocks install lua-cjson

# Verify isolation
luarocks list                                   # Shows only alpha's packages
.\use-lua.ps1 -Alias prod && luarocks list     # Shows different package set

# Use custom package tree for specific project
.\use-lua.ps1 -Alias alpha -Tree "C:\Projects\MyProject\lua_modules"
```

### Registry System Architecture

**Directory Structure**:
```
%USERPROFILE%\.luaenv\
â”œâ”€â”€ registry.json                  # Master registry file
â”œâ”€â”€ registry.json.backup           # Automatic backup
â”œâ”€â”€ installations\                 # All Lua installations
â”‚   â”œâ”€â”€ {uuid-1}\                 # Installation 1
â”‚   â”‚   â”œâ”€â”€ bin\                  # lua.exe, luac.exe, lua54.dll
â”‚   â”‚   â”œâ”€â”€ lib\                  # lua54.lib, lua54.exp
â”‚   â”‚   â”œâ”€â”€ include\              # Lua headers
â”‚   â”‚   â”œâ”€â”€ doc\                  # Documentation
â”‚   â”‚   â””â”€â”€ luarocks\             # luarocks.exe, luarocks-admin.exe
â”‚   â””â”€â”€ {uuid-2}\                 # Installation 2 (different version/build)
â”œâ”€â”€ environments\               # Isolated LuaRocks package trees
â”‚   â”œâ”€â”€ {uuid-1}\                # Environment for installation 1
â”‚   â”‚   â”œâ”€â”€ lib\lua\5.4\         # Binary packages (.dll)
â”‚   â”‚   â”œâ”€â”€ share\lua\5.4\       # Lua packages (.lua)
â”‚   â”‚   â””â”€â”€ lib\luarocks\rocks-5.4\ # Package metadata
â”‚   â””â”€â”€ {uuid-2}\                # Environment for installation 2
â””â”€â”€ cache\                        # Temporary build files
```

**Registry File Format**:
```json
{
  "version": "2.0",
  "default": "8202bd2b-1f86-4cfb-acf4-a14641add5d2",
  "installations": {
    "8202bd2b-1f86-4cfb-acf4-a14641add5d2": {
      "id": "8202bd2b-1f86-4cfb-acf4-a14641add5d2",
      "name": "Lua 5.4.8 DLL Release",
      "alias": "test",
      "lua_version": "5.4.8",
      "luarocks_version": "3.12.2",
      "build_type": "dll",
      "build_config": "release",
      "status": "active",
      "created": "2025-06-30T10:15:30Z",
      "last_used": "2025-06-30T12:45:15Z",
      "installation_path": "C:\\Users\\darel\\.luaenv\\installations\\8202bd2b-1f86-4cfb-acf4-a14641add5d2",
      "environment_path": "C:\\Users\\darel\\.luaenv\\environments\\8202bd2b-1f86-4cfb-acf4-a14641add5d2"
    }
  },
  "aliases": {
    "test": "8202bd2b-1f86-4cfb-acf4-a14641add5d2"
  }
}
```

### setup-luarocks.bat - LuaRocks Configuration Helper
**Purpose**: Configures LuaRocks to work with a specific Lua build, handling both static and DLL build types with proper library linking.

**Command Line Arguments**:
- `setup-luarocks.bat` - Interactive mode (prompts for Lua directory)
- `setup-luarocks.bat <lua_dir>` - Configure for specific Lua installation
- `setup-luarocks.bat C:\lua` - Example with absolute path
- `setup-luarocks.bat lua-5.4.8` - Example with relative path

**Key Features**:
- **Build Type Detection**: Automatically detects static vs DLL builds
- **LuaRocks Validation**: Verifies LuaRocks is installed and accessible
- **Lua Installation Validation**: Checks for lua.exe and luac.exe
- **Configuration Setup**: Sets all necessary LuaRocks configuration parameters
- **Library Linking**: Configures proper library paths for C extension compilation

**Build Type Detection Logic**:
- **DLL Build**: Detected by presence of lua54.dll in bin directory
- **Static Build**: Default when lua54.dll is not found
- **Configuration Differences**: Different library linking setup for each type
- **Runtime Warnings**: Alerts about DLL path requirements for DLL builds

**LuaRocks Configuration Parameters**:
- **lua_interpreter**: Path to lua.exe executable
- **lua_compiler**: Path to luac.exe compiler
- **lua_version**: Set to 5.4 for version compatibility
- **lua_incdir**: Path to Lua header files (include directory)
- **lua_libdir**: Path to Lua library files (lib directory)
- **lua_libname**: Library name (lua54.lib for both static and DLL)

**Validation Checks**:
- **LuaRocks Availability**: Uses `where luarocks.exe` to verify installation
- **Lua Executables**: Checks for lua.exe and luac.exe in expected locations
- **Path Resolution**: Converts relative paths to absolute paths
- **Error Handling**: Provides clear error messages and exit codes

**Configuration Process**:
1. **Verify LuaRocks**: Confirms LuaRocks is installed and in PATH
2. **Get Lua Directory**: From command line argument or user input
3. **Validate Installation**: Checks lua.exe and luac.exe exist
4. **Detect Build Type**: Determines static vs DLL build
5. **Configure LuaRocks**: Sets all necessary configuration parameters
6. **Provide Guidance**: Shows configuration summary and usage instructions

**Output Information**:
- **Configuration Summary**: Shows all configured paths and settings
- **Build Type Information**: Displays detected build type and implications
- **Installation Locations**: Explains where packages will be installed
- **Usage Examples**: Provides examples of common LuaRocks commands
- **Path Setup Instructions**: Guidance for adding LuaRocks to PATH permanently

**Integration Notes**:
- **VS Developer Prompt**: Should be run from Visual Studio Developer Command Prompt
- **DLL Runtime**: For DLL builds, reminds about lua54.dll PATH requirements
- **Package Trees**: Explains user vs system package installation locations
- **Custom Trees**: Shows how to use --tree option for project-specific installations

## Complete Workflow Test - July 1, 2025

### Summary: Fresh Installation and Global Script Workflow Validation

Successfully completed a comprehensive clean-slate test of the entire LuaEnv system, validating all major functionality from initial setup through advanced multi-environment usage.

### Test Environment Preparation

**Step 1: Complete System Cleanup**
```powershell
# Cleaned all previous state
Remove-Item -Recurse -Force downloads\*
Remove-Item -Recurse -Force extracted\*
Remove-Item -Force version_cache.json
Remove-Item -Recurse -Force C:\Users\darel\.luaenv
Remove-Item -Recurse -Force __pycache__
```

**Verification**: Confirmed all directories empty and no existing LuaEnv registry

### Global Script Installation and Setup

**Step 2: Install LuaEnv Scripts Globally**
```powershell
python registry.py install-scripts
```

**Results**:
- Scripts installed to `%USERPROFILE%\.luaenv\bin`
- Created: `setenv.ps1`, `use-lua.ps1`, `luaenv.ps1`
- Provided PATH setup instructions
- Registry system initialized

**Step 3: Verify Registry Status**
```powershell
python registry.py status
```

**Results**: Empty registry confirmed, ready for installations

### First Installation - DLL Build

**Step 4: Create Test Installation (DLL Build)**
```powershell
python setup_lua.py --dll --name "Test Build" --alias test
```

**Workflow Validated**:
- Registry creation and UUID generation
- Visual Studio environment setup
- Source download (Lua 5.4.8, LuaRocks 3.12.2)
- Extraction to `backend/extracted/`
- Build script setup
- DLL compilation with MSVC
- Installation to UUID-based directory
- LuaRocks configuration for DLL build
- Comprehensive test suite execution
- Registry status update to "active"

**Step 5: Test Global Script Access**
```powershell
C:\Users\darel\.luaenv\bin\use-lua.ps1 -List
```

**Results**: Successfully listed installation from global script location

### Environment Activation and Package Management

**Step 6: Test Environment Activation with Directory Preservation**
```powershell
cd c:\
C:\Users\darel\.luaenv\bin\use-lua.ps1 -Alias test
pwd  # Verified still in C:\
```

**Validation**:
- Visual Studio Developer Shell launched with `-SkipAutomaticLocation`
- Working directory preserved correctly
- Environment variables configured for isolation
- LuaRocks configured with isolated package tree

**Step 7: Test Lua and LuaRocks Functionality**
```powershell
lua -v
luarocks --version
```

**Results**: Both tools working correctly in activated environment

**Step 8: Test Package Installation and Isolation**
```powershell
luarocks install penlight
```

**Validation**:
- Packages installed to isolated environment tree
- C extension compilation worked with Visual Studio integration
- Dependencies (luafilesystem) resolved automatically
- Packages installed to: `%USERPROFILE%\.luaenv\environments\{uuid}\`

**Step 9: Test Installed Packages**
```powershell
lua -e "local pl = require('pl.pretty'); pl.dump({status='success', message='Penlight is working!'})"
```

**Results**: Package functionality confirmed in isolated environment

### Second Installation - Static Build

**Step 10: Create Production Installation (Static Build)**
```powershell
python setup_lua.py --name "Production Build" --alias prod
```

**Workflow Validated**:
- Second installation created with different UUID
- Static build configuration (no DLL)
- Separate installation directory
- Separate isolated environment tree
- Build reused existing downloaded sources
- LuaRocks configured for static linking

### Multi-Environment Testing

**Step 11: Verify Multiple Installations**
```powershell
python registry.py list
```

**Results**: Two installations listed:
- Test Build (DLL, alias: test) - DEFAULT
- Production Build (static, alias: prod) - ACTIVE

**Step 12: Test Environment Switching**
```powershell
C:\Users\darel\.luaenv\bin\use-lua.ps1 -Alias prod
```

**Validation**: Successfully switched to production environment

**Step 13: Verify Package Isolation**
```powershell
luarocks list  # Empty in prod environment
```

**Results**: Production environment has no packages (perfect isolation)

**Step 14: Test Different Package in Production**
```powershell
luarocks install lua-cjson
lua -e "local cjson = require('cjson'); print(cjson.encode({environment='production'}))"
```

**Validation**:
- Different package installed successfully
- C extension compilation worked with static build
- Package functionality confirmed

**Step 15: Verify Test Environment Integrity**
```powershell
C:\Users\darel\.luaenv\bin\use-lua.ps1 -Alias test
luarocks list
lua -e "local pl = require('pl.pretty'); pl.dump({environment='test'})"
```

**Results**: Test environment still has original packages (penlight, luafilesystem)

### Final System Validation

**Step 16: Comprehensive Status Check**
```powershell
C:\Users\darel\.luaenv\bin\luaenv.ps1 status
```

**Final Results**:
- 2 active installations with complete isolation
- Registry tracking both installations with aliases
- Global scripts accessible and functional
- Environment switching working perfectly
- Package isolation confirmed between environments

### Key Achievements Validated

1. **âœ… Global Script Installation**: Scripts accessible from `%USERPROFILE%\.luaenv\bin`
2. **âœ… Registry Management**: Full UUID-based tracking with aliases
3. **âœ… Multiple Build Types**: Both DLL and static builds working
4. **âœ… Environment Isolation**: Completely separate package trees
5. **âœ… Package Management**: LuaRocks working with C extension compilation
6. **âœ… Directory Preservation**: Visual Studio setup doesn't change working directory
7. **âœ… CLI Management**: All registry operations through command-line tools
8. **âœ… Visual Studio Integration**: Automatic VS Developer Shell setup

### System Architecture Confirmed Working

```
%USERPROFILE%\.luaenv\
â”œâ”€â”€ bin\                          # Global scripts directory
â”‚   â”œâ”€â”€ setenv.ps1               # VS environment setup
â”‚   â”œâ”€â”€ use-lua.ps1              # Environment activation
â”‚   â””â”€â”€ luaenv.ps1               # Registry wrapper
â”œâ”€â”€ registry.json                # Central installation registry
â”œâ”€â”€ installations\               # UUID-named installation directories
â”‚   â”œâ”€â”€ {test-uuid}\            # Test Build (DLL)
â”‚   â”‚   â”œâ”€â”€ bin\                # lua.exe, luac.exe, lua54.dll
â”‚   â”‚   â”œâ”€â”€ lib\                # lua54.lib, lua54.exp
â”‚   â”‚   â”œâ”€â”€ include\            # Headers
â”‚   â”‚   â””â”€â”€ luarocks\           # LuaRocks executables
â”‚   â””â”€â”€ {prod-uuid}\            # Production Build (static)
â”‚       â”œâ”€â”€ bin\                # lua.exe, luac.exe (no DLL)
â”‚       â”œâ”€â”€ lib\                # lua54.lib
â”‚       â”œâ”€â”€ include\            # Headers
â”‚       â””â”€â”€ luarocks\           # LuaRocks executables
â””â”€â”€ environments\               # Isolated package trees
    â”œâ”€â”€ {test-uuid}\            # Test environment packages
    â”‚   â””â”€â”€ lib\lua\5.4\        # penlight, luafilesystem
    â””â”€â”€ {prod-uuid}\            # Production environment packages
        â””â”€â”€ lib\lua\5.4\        # lua-cjson
```

### Next Steps for Development

The system is now fully operational and ready for:
1. **Production Use**: Complete workflow validated and stable
2. **Documentation Updates**: All features documented and tested
3. **Additional Features**: Ready for enhancement and expansion
4. **User Adoption**: System ready for real-world usage scenarios

**Status**: [SUCCESS] - Option 2 (Global LuaEnv bin/) fully implemented and validated through comprehensive testing.
```
